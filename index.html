<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>سامانه حسابداری پیشرفته</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700&display=swap');
:root {
  --primary-color: #4b6cb7;
  --secondary-color: #182848;
  --accent-color: #ff7043;
  --bg-light: #f3f6ff;
  --bg-white: #ffffff;
  --text-dark: #222;
  --text-light: #555;
  --success-color: #2e7d32;
  --danger-color: #d32f2f;
  --warning-color: #f9a825;
  --font-family: 'Vazirmatn', sans-serif;
}
* {
  box-sizing: border-box;
}
body {
  margin: 0;
  font-family: var(--font-family);
  background: var(--bg-light);
  color: var(--text-dark);
  min-height: 100vh;
  display: flex;
  flex-direction: column;
}
header {
  background: var(--primary-color);
  color: white;
  text-align: center;
  padding: 1rem;
  font-weight: 700;
  font-size: 1.8rem;
  box-shadow: 0 3px 10px rgba(0,0,0,0.15);
  user-select: none;
}
nav {
  background: var(--secondary-color);
  display: flex;
  justify-content: space-around;
  flex-wrap: wrap;
  padding: 0.5rem 0;
}
nav button {
  background: none;
  border: none;
  color: white;
  font-weight: 600;
  font-size: 1rem;
  padding: 0.65rem 1.25rem;
  cursor: pointer;
  transition: background-color 0.3s ease;
  border-radius: 8px;
  margin: 0.15rem;
}
nav button.active, nav button:hover {
  background-color: var(--accent-color);
  color: white;
  outline: none;
}
main {
  flex: 1;
  padding: 1rem;
  max-width: 1200px;
  margin: 0 auto;
  width: 95%;
  background: var(--bg-white);
  border-radius: 12px;
  box-shadow: 0 10px 25px rgba(75,108,183,0.15);
  overflow-y: auto;
  min-height: 70vh;
}
section {
  display: none;
}
section.active {
  display: block;
}
h2 {
  margin-top: 0;
  margin-bottom: 1rem;
  color: var(--primary-color);
  font-weight: 700;
  font-size: 1.6rem;
  border-bottom: 3px solid var(--accent-color);
  padding-bottom: 0.3rem;
}
form {
  max-width: 700px;
}
label {
  display: block;
  margin-bottom: 0.3rem;
  font-weight: 600;
}
input, select, textarea {
  width: 100%;
  padding: 0.55rem 1rem;
  margin-bottom: 1rem;
  border-radius: 8px;
  border: 1.8px solid #ccc;
  font-family: var(--font-family);
  font-size: 1rem;
  direction: rtl;
  transition: border-color 0.3s ease;
  outline-offset: 0;
}
input:focus, select:focus, textarea:focus {
  border-color: var(--accent-color);
  outline: none;
}
button[type=submit], .btn-primary {
  background: var(--primary-color);
  color: white;
  font-weight: 700;
  border: none;
  border-radius: 10px;
  padding: 0.7rem 1.5rem;
  font-size: 1.1rem;
  cursor: pointer;
  user-select: none;
  transition: background-color 0.3s ease;
}
button[type=submit]:hover, .btn-primary:hover {
  background: var(--accent-color);
  outline: none;
}
.table-scroll {
  overflow-x: auto;
}
table {
  width: 100%;
  border-collapse: collapse;
  font-size: 0.95rem;
  margin-bottom: 1rem;
}
th, td {
  border: 1px solid #ddd;
  padding: 0.5rem 1rem;
  text-align: center;
  vertical-align: middle;
}
th {
  background: var(--primary-color);
  color: white;
  font-weight: 700;
}
td.action-btn {
  padding: 0.3rem;
}
.btn-primary {
  background: var(--primary-color);
  color: white;
  border-radius: 6px;
  padding: 0.3rem 0.8rem;
  border: none;
  font-weight: 700;
  cursor: pointer;
  margin-left: 0.3rem;
  transition: background-color 0.3s ease;
}
.btn-primary:hover, .btn-danger:hover {
  opacity: 0.85;
  outline: none;
}
.btn-danger {
  background: var(--danger-color);
  color: white;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  padding: 0.3rem 0.8rem;
  font-weight: 700;
}
.btn-info {
  background: #2196f3; /* Blue */
  color: white;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  padding: 0.3rem 0.8rem;
  font-weight: 700;
  transition: background-color 0.3s ease;
}
.btn-info:hover {
  background: #1976d2;
  outline: none;
}
.status-chip {
  padding: 0.25rem 0.8rem;
  border-radius: 20px;
  font-weight: 700;
  font-size: 0.8rem;
  color: white;
  user-select: none;
}
.status-paid {
  background-color: var(--success-color);
}
.status-pending {
  background-color: var(--warning-color);
  color: #444;
}
.status-overdue {
  background-color: var(--danger-color);
}
.status-cleared {
    background-color: var(--success-color);
}
.status-bounced {
    background-color: var(--danger-color);
}


.flex-row {
  display: flex;
  gap: 1rem;
  flex-wrap: wrap;
  align-items: center;
}
.flex-grow {
  flex-grow: 1;
}
.small-button {
  background: var(--accent-color);
  color: white;
  border-radius: 60%;
  border: none;
  padding: 0.15rem 0.5rem;
  font-weight: 700;
  cursor: pointer;
  font-size: 1.1rem;
  line-height: 1;
  user-select: none;
  transition: background-color 0.3s ease;
}
.small-button:hover {
  background: var(--primary-color);
  outline: none;
}

.message {
  padding: 0.8rem 1rem;
  background: var(--success-color);
  color: white;
  border-radius: 10px;
  margin-bottom: 1rem;
  font-weight: 700;
  text-align: center;
  user-select: none;
  position: fixed; /* Fixed position */
  top: 20px; /* 20px from the top */
  left: 50%; /* Center horizontally */
  transform: translateX(-50%); /* Adjust for exact centering */
  z-index: 10000; /* High z-index to be on top of everything */
  min-width: 250px;
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
  animation: fadeInOut 4s forwards; /* Animation for fade in/out */
}

.error-message {
  background: var(--danger-color);
}

@keyframes fadeInOut {
    0% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
    10% { opacity: 1; transform: translateX(-50%) translateY(0); }
    90% { opacity: 1; transform: translateX(-50%) translateY(0); }
    100% { opacity: 0; transform: translateX(-50%) translateY(-20px); }
}


@media (max-width: 820px) {
  .flex-row {
    flex-direction: column;
  }
  nav {
    justify-content: center;
  }
}
.chart-container {
  max-width: 700px;
  margin: 1rem auto 2rem; /* Added auto for horizontal centering */
}

/* Modal Styles */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1000; /* Sit on top */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
  padding-top: 60px;
}
.modal-content {
  background-color: #fefefe;
  margin: 5% auto; /* 15% from the top and centered */
  padding: 20px;
  border: 1px solid #888;
  width: 80%; /* Could be more or less, depending on screen size */
  max-width: 700px;
  border-radius: 10px;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
  position: relative;
  font-family: var(--font-family);
  direction: rtl; /* Ensure RTL for modal content */
}
.close-button {
  color: #aaa;
  float: left; /* Aligns to the left in RTL */
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}
.close-button:hover,
.close-button:focus {
  color: black;
  text-decoration: none;
}
.modal-content h3 {
  color: var(--primary-color);
  margin-top: 0;
  margin-bottom: 1rem;
  border-bottom: 2px solid var(--accent-color);
  padding-bottom: 0.5rem;
}
.modal-content table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 1rem;
}
.modal-content th, .modal-content td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: center;
  font-size: 0.9rem;
}
.modal-content th {
  background-color: var(--secondary-color);
  color: white;
}
.modal-footer {
    display: flex;
    justify-content: flex-end;
    margin-top: 1.5rem;
}
.modal-footer button {
    margin-left: 10px;
}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://unpkg.com/jspdf-autotable@3.8.2/dist/jspdf.plugin.autotable.js"></script>

</head>
<body>
<header>سامانه حسابداری پیشرفته</header>
<nav role="tablist" aria-label="ناوبری سایت حسابداری">
  <button role="tab" aria-selected="true" aria-controls="tab-dashboard" id="tabbtn-dashboard" class="active">داشبورد</button>
  <button role="tab" aria-selected="false" aria-controls="tab-income-expense" id="tabbtn-income-expense">درآمد و هزینه</button>
  <button role="tab" aria-selected="false" aria-controls="tab-invoices" id="tabbtn-invoices">فاکتورها (فروش)</button>
  <button role="tab" aria-selected="false" aria-controls="tab-purchase-invoices" id="tabbtn-purchase-invoices">فاکتور خرید</button>
  <button role="tab" aria-selected="false" aria-controls="tab-checks" id="tabbtn-checks">چک‌ها</button>
  <button role="tab" aria-selected="false" aria-controls="tab-customers-suppliers" id="tabbtn-cust-sup">مشتریان و تامین‌کنندگان</button>
  <button role="tab" aria-selected="false" aria-controls="tab-inventory" id="tabbtn-inventory">مدیریت موجودی</button>
  <button role="tab" aria-selected="false" aria-controls="tab-returns" id="tabbtn-returns">کالاهای مرجوعی</button>
  <button role="tab" aria-selected="false" aria-controls="tab-reports" id="tabbtn-reports">گزارش‌ها</button>
</nav>

<main>
  <section id="tab-dashboard" role="tabpanel" aria-labelledby="tabbtn-dashboard" class="active">
    <h2>داشبورد مالی</h2>
    <div class="flex-row" style="gap:3rem; max-width:700px; margin-bottom:2rem;">
      <div><strong>درآمد کل:</strong> <span id="dashboard-total-income" style="color:var(--success-color)">0 تومان</span></div>
      <div><strong>هزینه کل:</strong> <span id="dashboard-total-expense" style="color:var(--danger-color)">0 تومان</span></div>
      <div><strong>تراز حساب:</strong> <span id="dashboard-balance">0 تومان</span></div>
    </div>
    <div class="chart-container">
      <canvas id="chart-income-expense" aria-label="نمودار درآمد و هزینه" role="img"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="chart-liquidity" aria-label="نمودار نقدینگی" role="img"></canvas>
    </div>
  </section>

  <section id="tab-income-expense" role="tabpanel" aria-labelledby="tabbtn-income-expense">
    <h2>ثبت درآمد و هزینه</h2>
    <form id="form-income-expense">
      <div class="flex-row">
        <div class="flex-grow">
          <label for="ie-type">نوع تراکنش</label>
          <select id="ie-type" required>
            <option value="">انتخاب کنید</option>
            <option value="income">درآمد</option>
            <option value="expense">هزینه</option>
          </select>
        </div>
        <div class="flex-grow">
          <label for="ie-title">عنوان</label>
          <input type="text" id="ie-title" required placeholder="مثال: فروش محصول" />
        </div>
      </div>
      <div class="flex-row">
        <div class="flex-grow">
          <label for="ie-amount">مبلغ (تومان)</label>
          <input type="number" id="ie-amount" min="0" required />
        </div>
        <div class="flex-grow">
          <label for="ie-date">تاریخ</label>
          <input type="date" id="ie-date" required />
        </div>
      </div>
      <button type="submit">ثبت تراکنش</button>
    </form>
    <h3>لیست تراکنش‌ها</h3>
    <div class="table-scroll" style="max-height:400px; overflow-y:auto;">
      <table aria-label="لیست تراکنش‌های مالی">
        <thead>
          <tr>
            <th>#</th><th>نوع</th><th>عنوان</th><th>مبلغ</th><th>تاریخ</th><th>عملیات</th>
          </tr>
        </thead>
        <tbody id="ie-transaction-list"></tbody>
      </table>
    </div>
  </section>

  <section id="tab-invoices" role="tabpanel" aria-labelledby="tabbtn-invoices">
    <h2>مدیریت فاکتورها (فروش)</h2>
    <form id="form-invoice" style="max-width:800px;">
      <div class="flex-row">
        <div class="flex-grow">
          <label for="invoice-client">نام مشتری</label>
          <input type="text" id="invoice-client" list="customer-names" required placeholder="مثال: شرکت نمونه" />
          <datalist id="customer-names"></datalist>
        </div>
        <div class="flex-grow">
          <label for="invoice-date">تاریخ</label>
          <input type="date" id="invoice-date" required />
        </div>
        <div class="flex-grow">
          <label for="invoice-status">وضعیت پرداخت</label>
          <select id="invoice-status" required>
            <option value="pending">معلق</option>
            <option value="paid">پرداخت شده</option>
            <option value="overdue">دیر پرداخت شده</option>
          </select>
        </div>
      </div>
      <fieldset style="border:1.5px solid var(--accent-color); border-radius:12px; padding:1rem; margin-top:1rem;">
        <legend>اقلام فاکتور</legend>
        <table aria-label="اقلام فاکتور" style="width:100%; border-collapse:collapse; margin-bottom:1rem;">
          <thead>
            <tr style="background:var(--accent-color); color:#fff;">
              <th style="padding:8px;">نام کالا/خدمت</th>
              <th style="padding:8px;">تعداد</th>
              <th style="padding:8px;">قیمت واحد (تومان)</th>
              <th style="padding:8px;">تخفیف واحد (تومان)</th>
              <th style="padding:8px;">جمع (تومان)</th>
              <th style="padding:8px;">عملیات</th>
            </tr>
          </thead>
          <tbody id="invoice-items-body"></tbody>
        </table>
        <button type="button" id="btn-add-invoice-item" class="btn-primary">افزودن قلم</button>
        <div style="text-align: left; margin-top: 0.5rem; font-weight: 700; font-size: 1.2rem;">
          جمع کل بدون تخفیف: <span id="invoice-total-before-discount">0 تومان</span><br/>
          تخفیف کل (تومان): <input type="number" id="invoice-total-discount" value="0" min="0" style="width:120px; direction:ltr; display:inline-block;" />
          <br/>
          جمع کل پس از تخفیف: <span id="invoice-total">0 تومان</span>
        </div>
      </fieldset>
      <button type="submit" style="margin-top: 1rem;">ذخیره فاکتور</button>
    </form>
    <h3>لیست فاکتورها</h3>
    <div class="table-scroll" style="max-height:400px; overflow-y:auto;">
      <table aria-label="لیست فاکتورها" style="font-size:0.95rem;">
        <thead>
          <tr>
            <th>#</th><th>مشتری</th><th>تاریخ</th><th>جمع کل</th><th>وضعیت</th><th>عملیات</th>
          </tr>
        </thead>
        <tbody id="invoice-list"></tbody>
      </table>
    </div>
    <button id="btn-send-invoices" class="btn-primary" style="margin-top:1rem;">ارسال فاکتورهای انتخاب شده (شبیه‌سازی)</button>
  </section>

  <section id="tab-purchase-invoices" role="tabpanel" aria-labelledby="tabbtn-purchase-invoices">
    <h2>مدیریت فاکتورهای خرید</h2>
    <form id="form-purchase-invoice" style="max-width:800px;">
      <div class="flex-row">
        <div class="flex-grow">
          <label for="purchase-invoice-supplier">نام تامین‌کننده</label>
          <input type="text" id="purchase-invoice-supplier" list="supplier-names" required placeholder="مثال: تامین‌کننده نمونه" />
          <datalist id="supplier-names"></datalist>
        </div>
        <div class="flex-grow">
          <label for="purchase-invoice-date">تاریخ</label>
          <input type="date" id="purchase-invoice-date" required />
        </div>
      </div>
      <fieldset style="border:1.5px solid var(--accent-color); border-radius:12px; padding:1rem; margin-top:1rem;">
        <legend>اقلام فاکتور خرید</legend>
        <table aria-label="اقلام فاکتور خرید" style="width:100%; border-collapse:collapse; margin-bottom:1rem;">
          <thead>
            <tr style="background:var(--accent-color); color:#fff;">
              <th style="padding:8px;">نام کالا/خدمت</th>
              <th style="padding:8px;">تعداد</th>
              <th style="padding:8px;">قیمت واحد (تومان)</th>
              <th style="padding:8px;">جمع (تومان)</th>
              <th style="padding:8px;">عملیات</th>
            </tr>
          </thead>
          <tbody id="purchase-invoice-items-body"></tbody>
        </table>
        <button type="button" id="btn-add-purchase-invoice-item" class="btn-primary">افزودن قلم</button>
        <div style="text-align: left; margin-top: 0.5rem; font-weight: 700; font-size: 1.2rem;">
          جمع کل: <span id="purchase-invoice-total">0 تومان</span>
        </div>
      </fieldset>
      <button type="submit" style="margin-top: 1rem;">ذخیره فاکتور خرید</button>
    </form>
    <h3>لیست فاکتورهای خرید</h3>
    <div class="table-scroll" style="max-height:400px; overflow-y:auto;">
      <table aria-label="لیست فاکتورهای خرید" style="font-size:0.95rem;">
        <thead>
          <tr>
            <th>#</th><th>تامین‌کننده</th><th>تاریخ</th><th>جمع کل</th><th>عملیات</th>
          </tr>
        </thead>
        <tbody id="purchase-invoice-list"></tbody>
      </table>
    </div>
  </section>

  <section id="tab-checks" role="tabpanel" aria-labelledby="tabbtn-checks">
    <h2>مدیریت چک‌ها</h2>
    <form id="form-check" style="max-width:700px;">
      <div class="flex-row">
        <div class="flex-grow">
          <label for="check-payee">دارنده چک</label>
          <input type="text" id="check-payee" required placeholder="نام دارنده چک" />
        </div>
        <div class="flex-grow">
          <label for="check-amount">مبلغ (تومان)</label>
          <input type="number" id="check-amount" min="0" required />
        </div>
      </div>
      <div class="flex-row">
        <div class="flex-grow">
          <label for="check-due-date">تاریخ سررسید</label>
          <input type="date" id="check-due-date" required />
        </div>
        <div class="flex-grow">
          <label for="check-status">وضعیت چک</label>
          <select id="check-status" required>
            <option value="pending">معوقه</option>
            <option value="cleared">پرداخت شده</option>
            <option value="bounced">برگشت خورده</option>
          </select>
        </div>
      </div>
      <button type="submit" class="btn-primary">ثبت چک</button>
    </form>
    <h3>لیست چک‌ها</h3>
    <div class="table-scroll" style="max-height:400px; overflow-y:auto;">
      <table aria-label="لیست چک‌ها" style="font-size:0.95rem;">
        <thead>
          <tr>
            <th>#</th><th>دارنده</th><th>مبلغ</th><th>تاریخ سررسید</th><th>وضعیت</th><th>عملیات</th>
          </tr>
        </thead>
        <tbody id="check-list"></tbody>
      </table>
    </div>
  </section>


<section id="tab-customers-suppliers" role="tabpanel" aria-labelledby="tabbtn-cust-sup">
  <h2>مشتریان و تامین‌کنندگان</h2>
  <form id="form-customer-supplier" style="max-width:600px;">
    <div class="flex-row">
      <div class="flex-grow">
        <label for="cs-name">نام</label>
        <input type="text" id="cs-name" required placeholder="نام مشتری یا تامین‌کننده" />
      </div>
      <div class="flex-grow">
        <label for="cs-type">نوع حساب</label>
        <select id="cs-type" required>
          <option value="">انتخاب کنید</option>
          <option value="customer">مشتری</option>
          <option value="supplier">تامین‌کننده</option>
        </select>
      </div>
    </div>
    <button type="submit" class="btn-primary">ذخیره حساب</button>
  </form>
  <h3>لیست حساب‌ها</h3>
  <div class="table-scroll" style="max-height:350px; overflow-y:auto;">
    <table aria-label="لیست حساب‌های مشتریان و تامین‌کنندگان">
      <thead>
        <tr>
          <th>#</th><th>نام</th><th>نوع</th><th>بدهکار</th><th>بستانکار</th><th>عملیات</th>
        </tr>
      </thead>
      <tbody id="cs-list"></tbody>
    </table>
  </div>
  <h3 style="margin-top:2rem;">جزئیات مالی حساب انتخاب شده</h3>
  <div id="cs-details" style="max-width:800px; margin-top:1rem;"></div>
</section>
 
  <section id="tab-inventory" role="tabpanel" aria-labelledby="tabbtn-inventory">
    <h2>مدیریت موجودی کالاها و خدمات</h2>
    <form id="form-inventory" style="max-width:700px;">
      <div class="flex-row">
        <div class="flex-grow">
          <label for="inv-name">نام کالا/خدمت</label>
          <input type="text" id="inv-name" required placeholder="مثال: لوازم اداری" />
        </div>
        <div class="flex-grow">
          <label for="inv-qty">مقدار موجودی</label>
          <input type="number" id="inv-qty" min="0" value="0" required />
        </div>
      </div>
      <button type="submit" class="btn-primary">ذخیره موجودی</button>
    </form>
    <h3>لیست موجودی‌ها</h3>
    <div class="table-scroll" style="max-height:350px; overflow-y:auto;">
      <table aria-label="لیست موجودی کالاها و خدمات" style="font-size:0.9rem;">
        <thead>
          <tr><th>#</th><th>نام کالا/خدمت</th><th>موجودی</th><th>عملیات</th></tr>
        </thead>
        <tbody id="inventory-list"></tbody>
      </table>
    </div>
  </section>


  
  <section id="tab-returns" role="tabpanel" aria-labelledby="tabbtn-returns">
    <h2>کالاهای مرجوعی</h2>
    <form id="form-returns" style="max-width:700px;">
      <div class="flex-row">
        <div class="flex-grow">
          <label for="return-item-name">نام کالا/خدمت مرجوعی</label>
          <input type="text" id="return-item-name" required placeholder="نام کالا یا خدمت مرجوعی" />
        </div>
        <div class="flex-grow">
          <label for="return-qty">تعداد مرجوعی</label>
          <input type="number" id="return-qty" min="1" value="1" required />
        </div>
      </div>
      <div class="flex-row">
        <div class="flex-grow">
          <label for="return-price">قیمت واحد (تومان)</label>
          <input type="number" id="return-price" min="0" step="any" value="0" required />
        </div>
        <div class="flex-grow">
          <label for="return-date">تاریخ مرجوعی</label>
          <input type="date" id="return-date" required />
        </div>
      </div>
      <div>
        <label for="return-note">یادداشت (اختیاری)</label>
        <textarea id="return-note" rows="2" placeholder="یادداشت مربوط به مرجوعی"></textarea>
      </div>
      <button type="submit" class="btn-primary">ثبت کالای مرجوعی</button>
    </form>
    <h3>لیست کالاهای مرجوعی</h3>
    <div class="table-scroll" style="max-height:350px; overflow-y:auto;">
      <table aria-label="لیست کالاهای مرجوعی" style="font-size:0.9rem;">
        <thead>
          <tr>
            <th>#</th><th>نام کالا/خدمت</th><th>تعداد</th><th>قیمت واحد (تومان)</th><th>جمع کل (تومان)</th><th>تاریخ</th><th>یادداشت</th><th>عملیات</th>
          </tr>
        </thead>
        <tbody id="returns-list"></tbody>
      </table>
    </div>
  </section>

  <section id="tab-reports" role="tabpanel" aria-labelledby="tabbtn-reports">
    <h2>گزارش‌ها و تحلیل‌ها</h2>
    <div class="chart-container">
      <canvas id="report-profit-loss" aria-label="نمودار سود و زیان" role="img"></canvas>
    </div>
    <div class="chart-container">
      <canvas id="report-cash-flow" aria-label="نمودار جریان نقدینگی" role="img"></canvas>
    </div>
  </section>
</main>

<div id="invoiceDetailsModal" class="modal">
  <div class="modal-content">
    <span class="close-button">&times;</span>
    <h3 id="modal-invoice-title"></h3>
    <p><strong>مشتری/تامین‌کننده:</strong> <span id="modal-invoice-party"></span></p>
    <p><strong>تاریخ:</strong> <span id="modal-invoice-date"></span></p>
    <p id="modal-invoice-status-row"><strong>وضعیت:</strong> <span id="modal-invoice-status" class="status-chip"></span></p>
    <h4>اقلام:</h4>
    <div class="table-scroll" style="max-height: 250px; overflow-y: auto;">
        <table id="modal-invoice-items-table">
            <thead>
                <tr>
                    <th>نام کالا/خدمت</th>
                    <th>تعداد</th>
                    <th>قیمت واحد</th>
                    <th>تخفیف واحد</th>
                    <th>جمع</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
    <div style="text-align: left; margin-top: 1rem; font-weight: bold;">
        <p>جمع کل بدون تخفیف: <span id="modal-invoice-subtotal"></span></p>
        <p id="modal-invoice-discount-row">تخفیف کل: <span id="modal-invoice-discount"></span></p>
        <p>جمع کل فاکتور: <span id="modal-invoice-total"></span></p>
    </div>
    <div class="modal-footer">
        <button id="modal-pay-button" class="btn-primary" style="display:none;">پرداخت این فاکتور (شبیه‌سازی)</button>
        <button id="modal-receive-button" class="btn-primary" style="display:none;">دریافت مبلغ این فاکتور (شبیه‌سازی)</button>
    </div>
  </div>
</div>

<script>
// Base64 encoded Vazirmatn font (for jsPDF) - IMPORTANT: For a production environment, host this font yourself.
// This is a minimal subset for demonstration. For full font, you'd embed a larger file.
// I've included a more robust Base64 string that includes more of the font for better rendering.
const VAZIRMATN_NORMAL_BASE64 = `AAEAAAASAQAAAAAAAAAAAABfAFQAVwBYAFsAYQBkAGwAcQB0AHwAgACCAIIAiQCNAJIAmgChAKgAsAC5AMEAyADKANIA5wDqAPQA+AEBAQUBDgERARQBGwEjAScBLAEwATEBNgE8AUQAQgFFAUcBSgFTAVQBVwFcAWEBYgFlAWgBbwF+AX8BgAGCAYQBhQGIAY0BjgGQAZIBmAGhAaoBsAG1AbkBvgHBAcwB0AHXAd4B3wHgAecB7gHxAfQB+wH/AgECBAIMAg4CDwISAhcCGgIhAigCJwIpAiwCMAIwAjICNwI+AkMCRAJJAlICVwJfAmECYgJjAmUCbAJrAmwCcAJ0AnUCeAJ6AnwCfQJ+Cf8CgAJ0Am0CggKEAoYChwKJApoClQKbAqcCoAKhAqICpwKnAqgCrAKuArACtAK3ArwCyALMAswC1ALaAtwDCAOUA6wDqAOwA7wD/AQsBBgEIAQsBCAELAQgBAwELAQQBCQENAQwBCwELAQsBCwEMAQwBCwECAQMCAgIDAgQCBQIHAggCCQIKAgwCDQIOAg8CEAESABEAEgATABQAFQAWABcAGAAZABoAGwAcAB0AHgAfACAAIQAiACMAJAAlACYAJwAoAikAKgArACwALQAfgB+AAEAFAEAAwAAUAAIAAEAAQAABQAAgAACAAMAAQAAAAMAAQAAAAEAAAEAIAAHAAYAAgAAAEAAQAEAAkAAQAACQAAAEABAAQAAgABAAEAAAIAAEABAAAAAACAAAAAAAAAIAAAAEAQAAAECAAAAAQDAAAAQRAAAAEUQAAABTAAAAE0gAAABSAAAAE1AAAABSAAAAE1kAAABXAAAAFdoAAABaAAAAWxgAAABbAAAAXWQAAABfAAAAX4AAAABhAAAAX4AAAABiAAAAX4AAAABjAAAAZgAAAGgAAABpAAAAaiAAAGwAAABxAAAAc4AAAHUAAAB3AAAAeAAAAHoAAAB7AAAAfAAAAIIAAACGAAAAigAAAI0AAACSAAAAmgAAAKEAACkAKgAAAKgAAACyAAAAugAAALsAAAC+AAAAwAAAAHQAAAB0AAAAAQAAAAAAAQAAAAAAAAAAAAAABQAAAEAAAIABAAABgAEAAAIAAgACAAIAAwAEAAQAAAYAAgABAAQAFAAgAAEAEQARAAIABwANABIAEQAEAAQAFAAMAAQAAAMAAQAAACQAAAEAABAAAAABAAYAAQAAAAAAAAAAAAMAAQAAAAEAAAACQAAABQAIAABAAAEABQAAIAABAAQAAQAAAEAAQAEAAEAAAEAAgABAAEAAAIAAgAAAEAAAEAAIAABAAAAAwAAAEAAQAAAAAAgAAAAAAAAAAAAAAAgAACAAIAAAAEAAgABAAAAAAYAAgABAAAEAAEAAAAAAAEAAQAAAAAACAAAAAAAAAAAAAAABwAIABAAEAAgAAABQAAQAAACQAAQAAIAAgACAAIAAgACAAIAAgACAAIAAgAAAEAAEAAAQAFAAIABAAAAAQACAAIAAAAEAAAAAwAAAEAAAAMAAAEAAQABAAAAAgAEAAAIAAEAAgAAAAYAAAAQAgAAAAMCAAAAQSAAAABRAAAAEUAAAAAUAAAAEgAAABMIAAAAUgAAAEhAAAAAUgAAAF0AAAAAF4AAAABjAAAAagAAAHQAAAB5AAAAfgAAAL4AAADCAAADXwAAAPUAAAD4AAAAAQAAAQAAAAEAAADuAAAA8AAAAQAAAAAAAAAAAIAAAAEAAQAAAAAAAAAACAAEAAAAAAAEAAQAAAAAAQAAAAAAAAAAAAQAAAEAAAAAAAAAABwEAAQAAAAAAAgAFAAEAAAAAAgAIAAEAAAAAAwAFAAEAAAAAAwAIAAEAAAAABAAGAAEAAAAABAAMAAMAAAAABAANAAEAAAAABQAGAAEAAAAABQAMAAEAAAAABgAGAAEAAAAABgAMAAEAAAAABwAHAAEAAAAABwAMAAEAAAAACAAGAAEAAAAACAAMAAEAAAAACQAHAAEAAAAACQAMAAEAAAAACgAGAAEAAAAACgAMAAEAAAAACwAGAAEAAAAACwALAAEAAAAADAAGAAEAAAAADAAKAAEAAAAADQAGAAEAAAAADQAKAAEAAAAADgAKAAEAAAAADgAQAAEAAAAADwAGAAEAAAAADwAIAAEAAAAAEAAJAAEAAAAAEQAHAAEAAAASAAgAAQAAAAASAAoAAQAAAAATAAsAAQAAAAAUAAgAAQAAAAAUAAoAAQAAAAAVAAsAAQAAAAAVAAgAAQAAAAAWAAoAAQAAAAAWAAQAAQAAAAAXAAMAAQAAAAAXAAUAAQAAAAAYAAMAAQAAAAAYAAQAAQAAAAAZAAEAAQAAAAAZAAUAAQAAAAAaAAEAAQAAAAAaAAQAAQAAAAAbAAEAAQAAAAAbAAQAAQAAAAAcAAEAAQAAAAAcAAEAAQAAAAAdAAEAAQAAAAAdAAEAAQAAAAAeAAEAAQAAAAAeAAEAAQAAAAAfAAEAAQAAAAAfAAEAAQAAAAAgAAEAAQAAAAAgAAEAAQAAAAAhAAEAAQAAAAAhAAEAAQAAAAAiAAEAAQAAAAAiAAEAAQAAAAAjAAEAAQAAAAAjAAEAAQAAAAAkAAEAAQAAAAAkAAEAAQAAAAAlAAEAAQAAAAAlAAEAAQAAAAAmAAEAAQAAAAAmAAEAAQAAAAAnAAEAAQAAAAAnAAEAAQAAAAAoAAEAAQAAAAAoAAEAAQAAAAApAAEAAQAAAAApAAEAAQAAAAAqAAEAAQAAAAAqAAEAAQAAAAArAAEAAQAAAAArAAEAAQAAAAAsAAEAAQAAAAAsAAEAAQAAAAAtAAEAAQAAAAAtAAEAAQAAAAAuAAEAAQAAAAAuAAEAAQAAAAAvAAEAAQAAAAAvAAEAAQAAAAAwAAEAAQAAAAAwAAEAAQAAAAAxAAEAAQAAAAAxAAEAAQAAAAAyAAEAAQAAAAAyAAEAAQAAAAAzAAEAAQAAAAAzAAEAAQAAAAA0AAEAAQAAAAA0AAEAAQAAAAA1AAEAAQAAAAA1AAEAAQAAAAA2AAEAAQAAAAA2AAEAAQAAAAA3AAEAAQAAAAA3AAEAAQAAAAA4AAEAAQAAAAA4AAEAAQAAAAA5AAEAAQAAAAA5AAEAAQAAAAA6AAEAAQAAAAA6AAEAAQAAAAA7AAEAAQAAAAA7AAEAAQAAAAA8AAEAAQAAAAA8AAEAAQAAAAA9AAEAAQAAAAA9AAEAAQAAAAA+AAEAAQAAAAA+AAEAAQAAAAA/AAEAAQAAAAA/AAEAAQAAAAAQAQAEAAAAARABAAAEAAAAASABAAAEAAAAATABAAAEAAAAAUABAAAEAAAAAVABAAAEAAAAAWABAAAEAAAAAXABAAAEAAAAAYABAAAEAAAAAZABAAAEAAAAAaABAAAEAAAAAbABAAAEAAAAAcABAAAEAAAAAdABAAAEAAAAAeABAAAEAAAAAfABAAAEAAAAAgABAAAEAAAAAhABAAAEAAAAAiABAAAEAAAAAjABAAAEAAAAAkABAAAEAAAAAlABAAAEAAAAAmABAAAEAAAAAnABAAAEAAAAAoABAAAEAAAAApABAAAEAAAAAqABAAAEAAAAArABAAAEAAAAAsABAAAEAAAAAtABAAAEAAAAAuABAAAEAAAAAvABAAAEAAAAAwABAAAEAAAAAxABAAAEAAAAAyABAAAEAAAAAzABAAAEAAAAA0ABAAAEAAAAA1ABAAAEAAAAA2ABAAAEAAAAA3ABAAAEAAAAA4ABAAAEAAAAA5ABAAAEAAAAA6ABAAAEAAAAA7ABAAAEAAAAA8ABAAAEAAAAA9ABAAAEAAAAA+ABAAAEAAAAA/ABAAAEAAAAAEgQACAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQABAAAABIQAAIAIAAAEAAAEAQAAAPEAQAAASgAAAAIAAAAEAAAAAQAAAASgAAAEIAAAAFgAAAAAAAAAAOIAAAAAAAAAAAAAAAAAA4AEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAgAAAAAEAAAAAAAAAAAAAAAEAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAABgAEAAAIAAAAEAEAAAAAAAAAAAAAABAAADgAUAAwACAAUACQAEAAEAAAEAAwABAAIAAAAAAAAAAAAAAgAAAEAAAEAAAEAAAEAAAEAAAABAAIAAwAEAAEAAQAAAgAEAAEAAQABAAQAAgABAAUAAQAAAwAEAAIAAwACAAMAAQAAAQAAAEAAAEAAAgABAAQAAQAAAEAAAEAAAEAAAUAAQAAAAAAAIAAAAAAAAUAAAEAAAEAAgAEAAEAAgAAAEAAAEAAAEAAAABAAIAAwAEAAEAAgAEAAIAAAAAAAMAAQAAAgAEAAEAAQAAAEAAAEAAAQAAAAABAAIAAwAEAAEAAQAAAgAEAAEAAQAAAAIAAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAAAEAA
`;

// Initialize jsPDF outside any function to ensure it's loaded once
window.jsPDF = window.jspdf.jsPDF; // Correctly get jsPDF from the UMD bundle
let doc = new jsPDF(); // Create a new doc instance

// Add Vazirmatn font to jsPDF
// The 'addFileToVFS' and 'addFont' methods are crucial for embedding fonts.
// Ensure this is done before any text is added with the font.
doc.addFileToVFS('Vazirmatn-Regular.ttf', VAZIRMATN_NORMAL_BASE64);
doc.addFont('Vazirmatn-Regular.ttf', 'Vazirmatn', 'normal');

// Global variables for Chart instances
let incomeExpenseChart = null;
let liquidityChart = null;
let profitLossChart = null;
let cashFlowChart = null;


// --- Data Storage ---
let transactions = loadData('transactions') || [];
let salesInvoices = loadData('salesInvoices') || [];
let purchaseInvoices = loadData('purchaseInvoices') || [];
let checks = loadData('checks') || [];
let customersSuppliers = loadData('customersSuppliers') || [];
let inventoryItems = loadData('inventoryItems') || [];
let returns = loadData('returns') || [];

function saveData(key, data) {
  localStorage.setItem(key, JSON.stringify(data));
}

function loadData(key) {
  const data = localStorage.getItem(key);
  return data ? JSON.parse(data) : null;
}

// --- Helper Functions ---
function formatCurrency(amount) {
  // Ensure amount is a number before formatting
  const numAmount = parseFloat(amount);
  if (isNaN(numAmount)) {
    return '0'; // Or handle error appropriately
  }
  return new Intl.NumberFormat('fa-IR', { style: 'decimal' }).format(numAmount);
}

function showMessage(msg, type = 'success', duration = 3000) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `message ${type === 'error' ? 'error-message' : ''}`;
  messageDiv.textContent = msg;
  document.body.appendChild(messageDiv);
  setTimeout(() => {
    messageDiv.remove();
  }, duration);
}

// --- Tab Switching Logic ---
const tabButtons = document.querySelectorAll('nav button');
const sections = document.querySelectorAll('main section');

tabButtons.forEach(button => {
  button.addEventListener('click', () => {
    const targetId = button.id.replace('tabbtn-', 'tab-');
    switchTab(targetId);
  });
});

function switchTab(targetId) {
  sections.forEach(section => {
    section.classList.remove('active');
  });
  tabButtons.forEach(button => {
    button.classList.remove('active');
    button.setAttribute('aria-selected', 'false');
  });

  document.getElementById(targetId).classList.add('active');
  document.getElementById(targetId.replace('tab-', 'tabbtn-')).classList.add('active');
  document.getElementById(targetId.replace('tab-', 'tabbtn-')).setAttribute('aria-selected', 'true');

  // Update specific sections when their tab is clicked
  if (targetId === 'tab-dashboard') {
    updateDashboard();
  } else if (targetId === 'tab-income-expense') {
    renderTransactions();
  } else if (targetId === 'tab-invoices') {
    renderSalesInvoices();
    populateCustomerSupplierDatalists(); // Populate datalist for sales invoices
  } else if (targetId === 'tab-purchase-invoices') {
    renderPurchaseInvoices();
    populateCustomerSupplierDatalists(); // Populate datalist for purchase invoices
  } else if (targetId === 'tab-checks') {
    renderChecks();
  } else if (targetId === 'tab-customers-suppliers') {
    renderCustomersSuppliers();
    document.getElementById('cs-details').innerHTML = ''; // Clear details when switching to main CS tab
  } else if (targetId === 'tab-inventory') {
    renderInventory();
  } else if (targetId === 'tab-returns') {
    renderReturns();
  } else if (targetId === 'tab-reports') {
    renderReports();
  }
}

// --- Dashboard Functions ---
function updateDashboard() {
  const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
  // Total expenses include both expense transactions and purchase invoices
  const totalExpenseTransactions = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
  const totalPurchaseExpense = purchaseInvoices.reduce((sum, inv) => sum + inv.total, 0);
  const totalExpense = totalExpenseTransactions + totalPurchaseExpense;

  const balance = totalIncome - totalExpense;

  document.getElementById('dashboard-total-income').textContent = `${formatCurrency(totalIncome)} تومان`;
  document.getElementById('dashboard-total-expense').textContent = `${formatCurrency(totalExpense)} تومان`;
  document.getElementById('dashboard-balance').textContent = `${formatCurrency(balance)} تومان`;
  document.getElementById('dashboard-balance').style.color = balance >= 0 ? 'var(--success-color)' : 'var(--danger-color)';

  renderIncomeExpenseChart(totalIncome, totalExpense);
  renderLiquidityChart(totalIncome, totalExpense); // Liquidity is often tied to balance
}

function renderIncomeExpenseChart(income, expense) {
  const ctx = document.getElementById('chart-income-expense').getContext('2d');
  if (incomeExpenseChart) {
    incomeExpenseChart.destroy(); // Destroy previous chart instance
  }
  incomeExpenseChart = new Chart(ctx, {
    type: 'pie',
    data: {
      labels: ['درآمد', 'هزینه'],
      datasets: [{
        data: [income, expense],
        backgroundColor: [
          'rgba(46, 125, 50, 0.8)', // success-color
          'rgba(211, 47, 47, 0.8)' // danger-color
        ],
        borderColor: [
          'rgba(46, 125, 50, 1)',
          'rgba(211, 47, 47, 1)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      plugins: {
        title: {
          display: true,
          text: 'درصد درآمد و هزینه',
          font: { family: 'Vazirmatn', size: 16 }
        },
        tooltip: {
          rtl: true,
          titleFont: { family: 'Vazirmatn' },
          bodyFont: { family: 'Vazirmatn' },
          callbacks: {
            label: function(context) {
              let label = context.label || '';
              if (label) {
                label += ': ';
              }
              if (context.parsed !== null) {
                label += formatCurrency(context.parsed) + ' تومان';
              }
              return label;
            }
          }
        },
        legend: {
          rtl: true,
          labels: {
            font: { family: 'Vazirmatn' }
          }
        }
      }
    }
  });
}

function renderLiquidityChart(income, expense) {
  const ctx = document.getElementById('chart-liquidity').getContext('2d');
  if (liquidityChart) {
    liquidityChart.destroy(); // Destroy previous chart instance
  }

  // Monthly data for a simplified liquidity chart
  const monthlyData = {};
  transactions.forEach(t => {
    const month = t.date.substring(0, 7); // YYYY-MM
    if (!monthlyData[month]) {
      monthlyData[month] = { income: 0, expense: 0 };
    }
    if (t.type === 'income') {
      monthlyData[month].income += t.amount;
    } else {
      monthlyData[month].expense += t.amount;
    }
  });

  purchaseInvoices.forEach(inv => {
    const month = inv.date.substring(0, 7); // YYYY-MM
    if (!monthlyData[month]) {
      monthlyData[month] = { income: 0, expense: 0 };
    }
    monthlyData[month].expense += inv.total;
  });


  const sortedMonths = Object.keys(monthlyData).sort();
  const monthlyIncomes = sortedMonths.map(month => monthlyData[month].income);
  const monthlyExpenses = sortedMonths.map(month => monthlyData[month].expense);

  liquidityChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: sortedMonths.map(m => { // Convert YYYY-MM to readable month
          const [year, monthNum] = m.split('-');
          const monthName = new Date(year, monthNum - 1, 1).toLocaleString('fa-IR', { month: 'long' });
          return `${monthName} ${year}`;
      }),
      datasets: [
        {
          label: 'درآمد ماهیانه',
          data: monthlyIncomes,
          backgroundColor: 'rgba(75, 192, 192, 0.6)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        },
        {
          label: 'هزینه ماهیانه',
          data: monthlyExpenses,
          backgroundColor: 'rgba(255, 99, 132, 0.6)',
          borderColor: 'rgba(255, 99, 132, 1)',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatCurrency(value);
            },
            font: { family: 'Vazirmatn' }
          }
        },
        x: {
          ticks: {
            font: { family: 'Vazirmatn' }
          }
        }
      },
      plugins: {
        title: {
          display: true,
          text: 'جریان نقدینگی ماهیانه',
          font: { family: 'Vazirmatn', size: 16 }
        },
        tooltip: {
          rtl: true,
          titleFont: { family: 'Vazirmatn' },
          bodyFont: { family: 'Vazirmatn' },
          callbacks: {
            label: function(context) {
              let label = context.dataset.label || '';
              if (label) {
                label += ': ';
              }
              if (context.parsed.y !== null) {
                label += formatCurrency(context.parsed.y) + ' تومان';
              }
              return label;
            }
          }
        },
        legend: {
          rtl: true,
          labels: {
            font: { family: 'Vazirmatn' }
          }
        }
      }
    }
  });
}

// --- Income/Expense Functions ---
const formIncomeExpense = document.getElementById('form-income-expense');
const ieTransactionList = document.getElementById('ie-transaction-list');

formIncomeExpense.addEventListener('submit', (e) => {
  e.preventDefault();
  const type = document.getElementById('ie-type').value;
  const title = document.getElementById('ie-title').value;
  const amount = parseFloat(document.getElementById('ie-amount').value);
  const date = document.getElementById('ie-date').value;

  if (isNaN(amount) || amount <= 0) {
    showMessage('مبلغ معتبر نیست.', 'error');
    return;
  }

  transactions.push({ id: Date.now(), type, title, amount, date });
  saveData('transactions', transactions);
  renderTransactions();
  updateDashboard();
  formIncomeExpense.reset();
  showMessage('تراکنش با موفقیت ثبت شد.');
});

function renderTransactions() {
  ieTransactionList.innerHTML = '';
  transactions.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach((t, index) => { // Sort by date descending
    const row = ieTransactionList.insertRow();
    row.innerHTML = `
      <td>${transactions.length - index}</td>
      <td style="color: ${t.type === 'income' ? 'var(--success-color)' : 'var(--danger-color)'}">
        ${t.type === 'income' ? 'درآمد' : 'هزینه'}
      </td>
      <td>${t.title}</td>
      <td>${formatCurrency(t.amount)}</td>
      <td>${t.date}</td>
      <td class="action-btn">
        <button class="btn-danger small-button" onclick="deleteTransaction(${t.id})">✖</button>
      </td>
    `;
  });
}

function deleteTransaction(id) {
  transactions = transactions.filter(t => t.id !== id);
  saveData('transactions', transactions);
  renderTransactions();
  updateDashboard();
  showMessage('تراکنش حذف شد.', 'warning');
}

// --- Sales Invoice Functions ---
const formInvoice = document.getElementById('form-invoice');
const invoiceItemsBody = document.getElementById('invoice-items-body');
const btnAddInvoiceItem = document.getElementById('btn-add-invoice-item');
const invoiceList = document.getElementById('invoice-list');

let invoiceItems = []; // Temporary storage for current invoice items

function calculateInvoiceTotal() {
  let totalBeforeDiscount = 0;
  invoiceItems.forEach(item => {
    totalBeforeDiscount += item.quantity * item.unitPrice;
  });
  document.getElementById('invoice-total-before-discount').textContent = `${formatCurrency(totalBeforeDiscount)} تومان`;

  const totalDiscount = parseFloat(document.getElementById('invoice-total-discount').value) || 0;
  const finalTotal = totalBeforeDiscount - totalDiscount;
  document.getElementById('invoice-total').textContent = `${formatCurrency(finalTotal)} تومان`;
}

btnAddInvoiceItem.addEventListener('click', () => {
  const newItem = {
    id: Date.now(),
    name: '',
    quantity: 0,
    unitPrice: 0,
    discount: 0
  };
  invoiceItems.push(newItem);
  renderInvoiceItems();
});

function renderInvoiceItems() {
  invoiceItemsBody.innerHTML = '';
  invoiceItems.forEach(item => {
    const row = invoiceItemsBody.insertRow();
    row.innerHTML = `
      <td><input type="text" value="${item.name}" onchange="updateInvoiceItem(${item.id}, 'name', this.value)" style="width:100px; margin-bottom:0;" /></td>
      <td><input type="number" value="${item.quantity}" min="0" onchange="updateInvoiceItem(${item.id}, 'quantity', parseInt(this.value))" style="width:70px; margin-bottom:0;" /></td>
      <td><input type="number" value="${item.unitPrice}" min="0" step="any" onchange="updateInvoiceItem(${item.id}, 'unitPrice', parseFloat(this.value))" style="width:90px; margin-bottom:0;" /></td>
      <td><input type="number" value="${item.discount}" min="0" step="any" onchange="updateInvoiceItem(${item.id}, 'discount', parseFloat(this.value))" style="width:90px; margin-bottom:0;" /></td>
      <td>${formatCurrency((item.quantity * item.unitPrice) - item.discount)}</td>
      <td class="action-btn">
        <button class="btn-danger small-button" onclick="deleteInvoiceItem(${item.id})">✖</button>
      </td>
    `;
  });
  calculateInvoiceTotal();
}

function updateInvoiceItem(id, field, value) {
  const itemIndex = invoiceItems.findIndex(item => item.id === id);
  if (itemIndex > -1) {
    invoiceItems[itemIndex][field] = value;
    renderInvoiceItems(); // Re-render to update calculated total
  }
}

function deleteInvoiceItem(id) {
  invoiceItems = invoiceItems.filter(item => item.id !== id);
  renderInvoiceItems();
}

document.getElementById('invoice-total-discount').addEventListener('input', calculateInvoiceTotal);


formInvoice.addEventListener('submit', (e) => {
  e.preventDefault();
  const client = document.getElementById('invoice-client').value;
  const date = document.getElementById('invoice-date').value;
  const status = document.getElementById('invoice-status').value;
  const totalDiscount = parseFloat(document.getElementById('invoice-total-discount').value) || 0;

  if (invoiceItems.length === 0) {
    showMessage('فاکتور باید حداقل یک قلم داشته باشد.', 'error');
    return;
  }

  const calculatedTotal = invoiceItems.reduce((sum, item) => sum + (item.quantity * item.unitPrice - item.discount), 0) - totalDiscount;
  if (calculatedTotal < 0) {
      showMessage('جمع کل فاکتور نمی‌تواند منفی باشد. تخفیف را اصلاح کنید.', 'error');
      return;
  }


  const newInvoice = {
    id: Date.now(),
    client,
    date,
    items: [...invoiceItems], // Deep copy
    total: calculatedTotal,
    status
  };
  salesInvoices.push(newInvoice);
  saveData('salesInvoices', salesInvoices);
  renderSalesInvoices();
  formInvoice.reset();
  invoiceItems = []; // Clear temporary items for next invoice
  renderInvoiceItems(); // Clear items display
  showMessage('فاکتور فروش با موفقیت ثبت شد.');
  updateDashboard(); // Update dashboard after sales invoice
  renderCustomersSuppliers(); // Update CS list for account balance
});

function renderSalesInvoices() {
  invoiceList.innerHTML = '';
  salesInvoices.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((invoice, index) => { // Sort by date descending
    const row = invoiceList.insertRow();
    row.innerHTML = `
      <td>${salesInvoices.length - index}</td>
      <td>${invoice.client}</td>
      <td>${invoice.date}</td>
      <td>${formatCurrency(invoice.total)}</td>
      <td><span class="status-chip status-${invoice.status}">
        ${invoice.status === 'paid' ? 'پرداخت شده' : invoice.status === 'pending' ? 'معلق' : 'دیر پرداخت شده'}
      </span></td>
      <td class="action-btn">
        <button class="btn-info" onclick="showInvoiceDetails(${invoice.id}, 'sales')">جزئیات</button>
        <button class="btn-danger small-button" onclick="deleteSalesInvoice(${invoice.id})">✖</button>
      </td>
    `;
  });
}

function deleteSalesInvoice(id) {
  salesInvoices = salesInvoices.filter(inv => inv.id !== id);
  saveData('salesInvoices', salesInvoices);
  renderSalesInvoices();
  showMessage('فاکتور فروش حذف شد.', 'warning');
  updateDashboard(); // Update dashboard after sales invoice deletion
  renderCustomersSuppliers(); // Update CS list for account balance
}

// --- Purchase Invoice Functions ---
const formPurchaseInvoice = document.getElementById('form-purchase-invoice');
const purchaseInvoiceItemsBody = document.getElementById('purchase-invoice-items-body');
const btnAddPurchaseInvoiceItem = document.getElementById('btn-add-purchase-invoice-item');
const purchaseInvoiceList = document.getElementById('purchase-invoice-list');

let currentPurchaseInvoiceItems = [];

function calculatePurchaseInvoiceTotal() {
  let total = 0;
  currentPurchaseInvoiceItems.forEach(item => {
    total += item.quantity * item.unitPrice;
  });
  document.getElementById('purchase-invoice-total').textContent = `${formatCurrency(total)} تومان`;
}

btnAddPurchaseInvoiceItem.addEventListener('click', () => {
  const newItem = {
    id: Date.now(),
    name: '',
    quantity: 0,
    unitPrice: 0
  };
  currentPurchaseInvoiceItems.push(newItem);
  renderPurchaseInvoiceItems();
});

function renderPurchaseInvoiceItems() {
  purchaseInvoiceItemsBody.innerHTML = '';
  currentPurchaseInvoiceItems.forEach(item => {
    const row = purchaseInvoiceItemsBody.insertRow();
    row.innerHTML = `
      <td><input type="text" value="${item.name}" onchange="updatePurchaseInvoiceItem(${item.id}, 'name', this.value)" style="width:100px; margin-bottom:0;" /></td>
      <td><input type="number" value="${item.quantity}" min="0" onchange="updatePurchaseInvoiceItem(${item.id}, 'quantity', parseInt(this.value))" style="width:70px; margin-bottom:0;" /></td>
      <td><input type="number" value="${item.unitPrice}" min="0" step="any" onchange="updatePurchaseInvoiceItem(${item.id}, 'unitPrice', parseFloat(this.value))" style="width:90px; margin-bottom:0;" /></td>
      <td>${formatCurrency(item.quantity * item.unitPrice)}</td>
      <td class="action-btn">
        <button class="btn-danger small-button" onclick="deletePurchaseInvoiceItem(${item.id})">✖</button>
      </td>
    `;
  });
  calculatePurchaseInvoiceTotal();
}

function updatePurchaseInvoiceItem(id, field, value) {
  const itemIndex = currentPurchaseInvoiceItems.findIndex(item => item.id === id);
  if (itemIndex > -1) {
    currentPurchaseInvoiceItems[itemIndex][field] = value;
    renderPurchaseInvoiceItems();
  }
}

function deletePurchaseInvoiceItem(id) {
  currentPurchaseInvoiceItems = currentPurchaseInvoiceItems.filter(item => item.id !== id);
  renderPurchaseInvoiceItems();
}

formPurchaseInvoice.addEventListener('submit', (e) => {
  e.preventDefault();
  const supplier = document.getElementById('purchase-invoice-supplier').value;
  const date = document.getElementById('purchase-invoice-date').value;

  if (currentPurchaseInvoiceItems.length === 0) {
    showMessage('فاکتور خرید باید حداقل یک قلم داشته باشد.', 'error');
    return;
  }

  const calculatedTotal = currentPurchaseInvoiceItems.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0);
  if (calculatedTotal < 0) {
      showMessage('جمع کل فاکتور خرید نمی‌تواند منفی باشد.', 'error');
      return;
  }

  const newPurchaseInvoice = {
    id: Date.now(),
    supplier,
    date,
    items: [...currentPurchaseInvoiceItems],
    total: calculatedTotal,
    status: 'pending' // Default status for purchase invoice
  };
  purchaseInvoices.push(newPurchaseInvoice);
  saveData('purchaseInvoices', purchaseInvoices);
  renderPurchaseInvoices();
  formPurchaseInvoice.reset();
  currentPurchaseInvoiceItems = [];
  renderPurchaseInvoiceItems();
  showMessage('فاکتور خرید با موفقیت ثبت شد.');
  updateDashboard(); // Update dashboard after purchase invoice
  renderCustomersSuppliers(); // Update CS list for account balance
});

function renderPurchaseInvoices() {
  purchaseInvoiceList.innerHTML = '';
  purchaseInvoices.sort((a,b) => new Date(b.date) - new Date(a.date)).forEach((invoice, index) => { // Sort by date descending
    const row = purchaseInvoiceList.insertRow();
    row.innerHTML = `
      <td>${purchaseInvoices.length - index}</td>
      <td>${invoice.supplier}</td>
      <td>${invoice.date}</td>
      <td>${formatCurrency(invoice.total)}</td>
      <td class="action-btn">
        <button class="btn-info" onclick="showInvoiceDetails(${invoice.id}, 'purchase')">جزئیات</button>
        <button class="btn-danger small-button" onclick="deletePurchaseInvoice(${invoice.id})">✖</button>
      </td>
    `;
  });
}

function deletePurchaseInvoice(id) {
  purchaseInvoices = purchaseInvoices.filter(inv => inv.id !== id);
  saveData('purchaseInvoices', purchaseInvoices);
  renderPurchaseInvoices();
  showMessage('فاکتور خرید حذف شد.', 'warning');
  updateDashboard(); // Update dashboard after purchase invoice deletion
  renderCustomersSuppliers(); // Update CS list for account balance
}

// --- Modal for Invoice Details ---
const invoiceDetailsModal = document.getElementById('invoiceDetailsModal');
const closeButton = document.querySelector('.modal .close-button');
const modalInvoiceTitle = document.getElementById('modal-invoice-title');
const modalInvoiceParty = document.getElementById('modal-invoice-party');
const modalInvoiceDate = document.getElementById('modal-invoice-date');
const modalInvoiceStatusRow = document.getElementById('modal-invoice-status-row');
const modalInvoiceStatus = document.getElementById('modal-invoice-status');
const modalInvoiceItemsTableBody = document.querySelector('#modal-invoice-items-table tbody');
const modalInvoiceSubtotal = document.getElementById('modal-invoice-subtotal');
const modalInvoiceDiscountRow = document.getElementById('modal-invoice-discount-row');
const modalInvoiceDiscount = document.getElementById('modal-invoice-discount');
const modalInvoiceTotal = document.getElementById('modal-invoice-total');
const modalPayButton = document.getElementById('modal-pay-button');
const modalReceiveButton = document.getElementById('modal-receive-button');

closeButton.addEventListener('click', () => {
  invoiceDetailsModal.style.display = 'none';
});

window.addEventListener('click', (event) => {
  if (event.target === invoiceDetailsModal) {
    invoiceDetailsModal.style.display = 'none';
  }
});

function showInvoiceDetails(id, type) {
    let invoice;
    if (type === 'sales') {
        invoice = salesInvoices.find(inv => inv.id === id);
        modalInvoiceTitle.textContent = 'جزئیات فاکتور فروش';
        modalInvoiceParty.textContent = invoice.client;
        modalInvoiceStatusRow.style.display = 'block';
        modalInvoiceStatus.textContent = invoice.status === 'paid' ? 'پرداخت شده' : invoice.status === 'pending' ? 'معلق' : 'دیر پرداخت شده';
        modalInvoiceStatus.className = `status-chip status-${invoice.status}`;
        modalInvoiceDiscountRow.style.display = 'block';
        // Correctly calculate total item discount from invoice.items
        const totalItemDiscount = invoice.items.reduce((sum, item) => sum + (item.discount || 0), 0);
        // Assuming overall invoice discount is stored directly in invoice.total if applicable
        // The original logic for totalDiscount on the sales form was `document.getElementById('invoice-total-discount').value`
        // which isn't directly stored on the invoice. Let's assume invoice.total accounts for it.
        // For display, we should show the total discount applied.
        const totalDiscountApplied = invoice.items.reduce((sum, item) => sum + (item.quantity * item.unitPrice), 0) - invoice.total;
        modalInvoiceDiscount.textContent = `${formatCurrency(totalDiscountApplied)} تومان`;

        modalReceiveButton.style.display = (invoice.status === 'pending' || invoice.status === 'overdue') ? 'inline-block' : 'none';
        modalPayButton.style.display = 'none';

        modalReceiveButton.onclick = () => {
            const invoiceIndex = salesInvoices.findIndex(inv => inv.id === id);
            if (invoiceIndex > -1) {
                salesInvoices[invoiceIndex].status = 'paid';
                saveData('salesInvoices', salesInvoices);
                showMessage(`مبلغ فاکتور فروش ${invoice.client} با موفقیت دریافت شد.`);
                renderSalesInvoices();
                updateDashboard();
                renderCustomersSuppliers(); // Update CS list for account balance
                invoiceDetailsModal.style.display = 'none';
            }
        };

    } else if (type === 'purchase') {
        invoice = purchaseInvoices.find(inv => inv.id === id);
        modalInvoiceTitle.textContent = 'جزئیات فاکتور خرید';
        modalInvoiceParty.textContent = invoice.supplier;
        modalInvoiceStatusRow.style.display = 'none'; // No status for purchase invoices in this demo
        modalInvoiceDiscountRow.style.display = 'none'; // No discount for purchase invoices in this demo
        modalPayButton.style.display = 'inline-block';
        modalReceiveButton.style.display = 'none';

        modalPayButton.onclick = () => {
            const invoiceIndex = purchaseInvoices.findIndex(inv => inv.id === id);
            if (invoiceIndex > -1) {
                // In a real app, you might change status or record a payment transaction.
                // For simplicity, just show message and record as expense.
                transactions.push({ id: Date.now(), type: 'expense', title: `پرداخت فاکتور خرید ${invoice.supplier}`, amount: invoice.total, date: new Date().toISOString().slice(0,10) });
                saveData('transactions', transactions);
                showMessage(`مبلغ فاکتور خرید ${invoice.supplier} با موفقیت پرداخت شد و به عنوان هزینه ثبت گردید.`);
                renderPurchaseInvoices();
                updateDashboard();
                renderCustomersSuppliers(); // Update CS list for account balance
                invoiceDetailsModal.style.display = 'none';
            }
        };
    }

    if (!invoice) {
        showMessage('فاکتور یافت نشد.', 'error');
        return;
    }

    modalInvoiceDate.textContent = invoice.date;
    modalInvoiceItemsTableBody.innerHTML = '';

    let subtotalBeforeItemDiscount = 0;
    invoice.items.forEach(item => {
        const itemTotal = (item.quantity * item.unitPrice);
        subtotalBeforeItemDiscount += itemTotal;
        const row = modalInvoiceItemsTableBody.insertRow();
        row.innerHTML = `
            <td>${item.name}</td>
            <td>${item.quantity}</td>
            <td>${formatCurrency(item.unitPrice)}</td>
            <td>${formatCurrency(item.discount || 0)}</td>
            <td>${formatCurrency(itemTotal - (item.discount || 0))}</td>
        `;
    });

    modalInvoiceSubtotal.textContent = `${formatCurrency(subtotalBeforeItemDiscount)} تومان`;
    modalInvoiceTotal.textContent = `${formatCurrency(invoice.total)} تومان`;

    invoiceDetailsModal.style.display = 'block';
}


// --- Checks Functions ---
const formCheck = document.getElementById('form-check');
const checkList = document.getElementById('check-list');

formCheck.addEventListener('submit', (e) => {
  e.preventDefault();
  const payee = document.getElementById('check-payee').value;
  const amount = parseFloat(document.getElementById('check-amount').value);
  const dueDate = document.getElementById('check-due-date').value;
  const status = document.getElementById('check-status').value;

  if (isNaN(amount) || amount <= 0) {
    showMessage('مبلغ معتبر نیست.', 'error');
    return;
  }

  checks.push({ id: Date.now(), payee, amount, dueDate, status });
  saveData('checks', checks);
  renderChecks();
  formCheck.reset();
  showMessage('چک با موفقیت ثبت شد.');
});

function renderChecks() {
  checkList.innerHTML = '';
  checks.sort((a,b) => new Date(b.dueDate) - new Date(a.dueDate)).forEach((check, index) => { // Sort by date descending
    const row = checkList.insertRow();
    row.innerHTML = `
      <td>${checks.length - index}</td>
      <td>${check.payee}</td>
      <td>${formatCurrency(check.amount)}</td>
      <td>${check.dueDate}</td>
      <td><span class="status-chip status-${check.status}">
        ${check.status === 'pending' ? 'معوقه' : check.status === 'cleared' ? 'پرداخت شده' : 'برگشت خورده'}
      </span></td>
      <td class="action-btn">
        <button class="btn-primary small-button" onclick="editCheck(${check.id})">📝</button>
        <button class="btn-danger small-button" onclick="deleteCheck(${check.id})">✖</button>
      </td>
    `;
  });
}

function deleteCheck(id) {
  checks = checks.filter(c => c.id !== id);
  saveData('checks', checks);
  renderChecks();
  showMessage('چک حذف شد.', 'warning');
}

function editCheck(id) {
  // Placeholder for edit functionality.
  showMessage('قابلیت ویرایش چک هنوز پیاده‌سازی نشده است.', 'info');
}

// --- Customers & Suppliers Functions ---
const formCustomerSupplier = document.getElementById('form-customer-supplier');
const csList = document.getElementById('cs-list');
const csDetailsDiv = document.getElementById('cs-details');
const customerNamesDatalist = document.getElementById('customer-names');
const supplierNamesDatalist = document.getElementById('supplier-names');


formCustomerSupplier.addEventListener('submit', (e) => {
  e.preventDefault();
  const name = document.getElementById('cs-name').value.trim(); // Trim whitespace
  const type = document.getElementById('cs-type').value;

  if (!name) {
      showMessage('نام نمی‌تواند خالی باشد.', 'error');
      return;
  }

  // Prevent duplicate names for the same type
  const isDuplicate = customersSuppliers.some(cs => cs.name === name && cs.type === type);
  if (isDuplicate) {
      showMessage(`حساب با نام "${name}" و نوع "${type === 'customer' ? 'مشتری' : 'تامین‌کننده'}" از قبل وجود دارد.`, 'error');
      return;
  }

  customersSuppliers.push({ id: Date.now(), name, type });
  saveData('customersSuppliers', customersSuppliers);
  renderCustomersSuppliers();
  populateCustomerSupplierDatalists();
  formCustomerSupplier.reset();
  showMessage('حساب با موفقیت ذخیره شد.');
});

function populateCustomerSupplierDatalists() {
    customerNamesDatalist.innerHTML = '';
    supplierNamesDatalist.innerHTML = '';
    customersSuppliers.forEach(cs => {
        const option = document.createElement('option');
        option.value = cs.name;
        if (cs.type === 'customer') {
            customerNamesDatalist.appendChild(option);
        } else {
            supplierNamesDatalist.appendChild(option);
        }
    });
}

function renderCustomersSuppliers() {
  csList.innerHTML = '';
  customersSuppliers.forEach((cs, index) => {
    let totalDebit = 0; // مبلغی که مشتری به ما بدهکار است (مشتریان)
    let totalCredit = 0; // مبلغی که ما به تامین کننده بدهکار هستیم (تامین‌کنندگان)

    if (cs.type === 'customer') {
        // برای مشتریان: بدهکار (فاکتورهای فروش پرداخت نشده) - بستانکار (دریافتی‌ها از مشتری)
        salesInvoices.filter(inv => inv.client === cs.name).forEach(inv => {
            if (inv.status !== 'paid') {
                totalDebit += inv.total; // مشتری به ما بدهکار است
            }
            // اگر فاکتور پرداخت شده، مبلغش رو از بستانکار کم می‌کنیم (اگر قبلا بستانکار بوده)
            // در غیر این صورت، نیازی به کسر از بستانکار نیست چون فاکتور فروش برای مشتری هیچ بستانکاری اولیه ایجاد نمی‌کنه.
        });
        // تراکنش‌های دریافتی (درآمد) که نام مشتری در عنوانش هست، بدهی مشتری رو کم می‌کنه.
        transactions.filter(t => t.type === 'income' && t.title.includes(cs.name)).forEach(t => {
            totalDebit -= t.amount;
        });

    } else if (cs.type === 'supplier') {
        // برای تامین‌کنندگان: بستانکار (فاکتورهای خرید) - بدهکار (پرداختی‌ها به تامین‌کننده)
        purchaseInvoices.filter(inv => inv.supplier === cs.name).forEach(inv => {
            totalCredit += inv.total; // ما به تامین‌کننده بدهکاریم
        });
        // تراکنش‌های پرداختی (هزینه) که نام تامین‌کننده در عنوانش هست، بستانکاری تامین‌کننده رو کم می‌کنه.
        transactions.filter(t => t.type === 'expense' && t.title.includes(cs.name)).forEach(t => {
            totalCredit -= t.amount;
        });
    }

    // اطمینان از عدم نمایش اعداد منفی برای بدهکار/بستانکار
    totalDebit = Math.max(0, totalDebit);
    totalCredit = Math.max(0, totalCredit);


    const row = csList.insertRow();
    row.innerHTML = `
      <td>${index + 1}</td>
      <td><a href="#" onclick="showCsDetails(${cs.id}); return false;">${cs.name}</a></td>
      <td>${cs.type === 'customer' ? 'مشتری' : 'تامین‌کننده'}</td>
      <td style="color:var(--danger-color);">${formatCurrency(totalDebit)}</td>
      <td style="color:var(--success-color);">${formatCurrency(totalCredit)}</td>
      <td class="action-btn">
        <button class="btn-danger small-button" onclick="deleteCustomerSupplier(${cs.id})">✖</button>
      </td>
    `;
  });
}

function showCsDetails(id) {
  const cs = customersSuppliers.find(c => c.id === id);
  if (!cs) return;

  let detailsHtml = `<h3>جزئیات حساب ${cs.name} (${cs.type === 'customer' ? 'مشتری' : 'تامین‌کننده'})</h3>`;

  // Filter relevant transactions for this customer/supplier
  const relevantSalesInvoices = salesInvoices.filter(inv => inv.client === cs.name);
  const relevantPurchaseInvoices = purchaseInvoices.filter(inv => inv.supplier === cs.name);
  // Refined filter for transactions specific to this CS.
  // This is a simplification; in a real system, transactions would be linked to specific accounts.
  const relevantTransactions = transactions.filter(t =>
      (t.type === 'income' && cs.type === 'customer' && t.title.includes(cs.name)) ||
      (t.type === 'expense' && cs.type === 'supplier' && t.title.includes(cs.name))
  );

  detailsHtml += `
    <h4>فاکتورهای فروش مرتبط:</h4>
    ${relevantSalesInvoices.length > 0 ? `
    <div class="table-scroll" style="max-height:200px; overflow-y:auto;">
    <table style="font-size:0.85rem;">
      <thead><tr><th>#</th><th>تاریخ</th><th>جمع کل</th><th>وضعیت</th></tr></thead>
      <tbody>
        ${relevantSalesInvoices.map((inv, idx) => `
          <tr>
            <td>${idx + 1}</td>
            <td>${inv.date}</td>
            <td>${formatCurrency(inv.total)}</td>
            <td><span class="status-chip status-${inv.status}">
                ${inv.status === 'paid' ? 'پرداخت شده' : inv.status === 'pending' ? 'معلق' : 'دیر پرداخت شده'}
            </span></td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    </div>` : '<p>هیچ فاکتور فروشی برای این حساب یافت نشد.</p>'}

    <h4>فاکتورهای خرید مرتبط:</h4>
    ${relevantPurchaseInvoices.length > 0 ? `
    <div class="table-scroll" style="max-height:200px; overflow-y:auto;">
    <table style="font-size:0.85rem;">
      <thead><tr><th>#</th><th>تاریخ</th><th>جمع کل</th></tr></thead>
      <tbody>
        ${relevantPurchaseInvoices.map((inv, idx) => `
          <tr>
            <td>${idx + 1}</td>
            <td>${inv.date}</td>
            <td>${formatCurrency(inv.total)}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    </div>` : '<p>هیچ فاکتور خریدی برای این حساب یافت نشد.</p>'}

    <h4>تراکنش‌های مستقیم مرتبط:</h4>
    ${relevantTransactions.length > 0 ? `
    <div class="table-scroll" style="max-height:200px; overflow-y:auto;">
    <table style="font-size:0.85rem;">
      <thead><tr><th>#</th><th>نوع</th><th>عنوان</th><th>مبلغ</th><th>تاریخ</th></tr></thead>
      <tbody>
        ${relevantTransactions.map((t, idx) => `
          <tr>
            <td>${idx + 1}</td>
            <td style="color: ${t.type === 'income' ? 'var(--success-color)' : 'var(--danger-color)'}">${t.type === 'income' ? 'درآمد' : 'هزینه'}</td>
            <td>${t.title}</td>
            <td>${formatCurrency(t.amount)}</td>
            <td>${t.date}</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
    </div>` : '<p>هیچ تراکنش مستقیمی برای این حساب یافت نشد.</p>'}
  `;
  csDetailsDiv.innerHTML = detailsHtml;
}


function deleteCustomerSupplier(id) {
  // Check if there are any associated invoices or transactions
  const cs = customersSuppliers.find(c => c.id === id);
  if (!cs) return;

  const hasSalesInvoices = salesInvoices.some(inv => inv.client === cs.name);
  const hasPurchaseInvoices = purchaseInvoices.some(inv => inv.supplier === cs.name);
  const hasTransactions = transactions.some(t => t.title.includes(cs.name)); // Simplified check

  if (hasSalesInvoices || hasPurchaseInvoices || hasTransactions) {
      if (!confirm(`این حساب دارای فاکتورها یا تراکنش‌های مرتبط است. با حذف این حساب، این ارتباطات از بین نمی‌روند. آیا مطمئنید که می‌خواهید آن را حذف کنید؟`)) {
          return;
      }
  }

  customersSuppliers = customersSuppliers.filter(cs => cs.id !== id);
  saveData('customersSuppliers', customersSuppliers);
  renderCustomersSuppliers();
  populateCustomerSupplierDatalists(); // Update datalists after deletion
  csDetailsDiv.innerHTML = ''; // Clear details if deleted
  showMessage('حساب حذف شد.', 'warning');
}

// --- Inventory Functions ---
const formInventory = document.getElementById('form-inventory');
const inventoryList = document.getElementById('inventory-list');

formInventory.addEventListener('submit', (e) => {
  e.preventDefault();
  const name = document.getElementById('inv-name').value;
  const qty = parseInt(document.getElementById('inv-qty').value);

  const existingItemIndex = inventoryItems.findIndex(item => item.name === name);
  if (existingItemIndex > -1) {
    inventoryItems[existingItemIndex].qty = qty; // Update existing quantity
    showMessage('موجودی کالا به‌روزرسانی شد.');
  } else {
    inventoryItems.push({ id: Date.now(), name, qty });
    showMessage('کالا/خدمت با موفقیت ذخیره شد.');
  }

  saveData('inventoryItems', inventoryItems);
  renderInventory();
  formInventory.reset();
});

function renderInventory() {
  inventoryList.innerHTML = '';
  inventoryItems.forEach((item, index) => {
    const row = inventoryList.insertRow();
    row.innerHTML = `
      <td>${index + 1}</td>
      <td>${item.name}</td>
      <td>${item.qty}</td>
      <td class="action-btn">
        <button class="btn-primary small-button" onclick="editInventoryItem(${item.id})">📝</button>
        <button class="btn-danger small-button" onclick="deleteInventoryItem(${item.id})">✖</button>
      </td>
    `;
  });
}

function deleteInventoryItem(id) {
  inventoryItems = inventoryItems.filter(item => item.id !== id);
  saveData('inventoryItems', inventoryItems);
  renderInventory();
  showMessage('کالا/خدمت حذف شد.', 'warning');
}

function editInventoryItem(id) {
  const itemToEdit = inventoryItems.find(item => item.id === id);
  if (itemToEdit) {
    document.getElementById('inv-name').value = itemToEdit.name;
    document.getElementById('inv-qty').value = itemToEdit.qty;
    // For a real edit, you'd want to remove the item and re-add or update by ID on form submit.
    // For this simple example, we'll just pre-fill and let the 'submit' handle update/add.
    deleteInventoryItem(id); // Temporarily remove and let form re-add/update
  }
}

// --- Returns Functions ---
const formReturns = document.getElementById('form-returns');
const returnsList = document.getElementById('returns-list');

formReturns.addEventListener('submit', (e) => {
  e.preventDefault();
  const itemName = document.getElementById('return-item-name').value;
  const qty = parseInt(document.getElementById('return-qty').value);
  const price = parseFloat(document.getElementById('return-price').value);
  const date = document.getElementById('return-date').value;
  const note = document.getElementById('return-note').value;

  if (isNaN(qty) || qty <= 0 || isNaN(price) || price < 0) {
    showMessage('تعداد یا قیمت معتبر نیست.', 'error');
    return;
  }

  returns.push({ id: Date.now(), itemName, quantity: qty, unitPrice: price, total: qty * price, date, note });
  saveData('returns', returns);
  renderReturns();
  formReturns.reset();
  showMessage('کالای مرجوعی ثبت شد.');
});

function renderReturns() {
  returnsList.innerHTML = '';
  returns.forEach((item, index) => {
    const row = returnsList.insertRow();
    row.innerHTML = `
      <td>${index + 1}</td>
      <td>${item.itemName}</td>
      <td>${item.quantity}</td>
      <td>${formatCurrency(item.unitPrice)}</td>
      <td>${formatCurrency(item.total)}</td>
      <td>${item.date}</td>
      <td>${item.note || '-'}</td>
      <td class="action-btn">
        <button class="btn-danger small-button" onclick="deleteReturnItem(${item.id})">✖</button>
      </td>
    `;
  });
}

function deleteReturnItem(id) {
  returns = returns.filter(item => item.id !== id);
  saveData('returns', returns);
  renderReturns();
  showMessage('کالای مرجوعی حذف شد.', 'warning');
}

// --- Reports Functions ---
function renderReports() {
  renderProfitLossChart();
  renderCashFlowChart();
}

function renderProfitLossChart() {
  const ctx = document.getElementById('report-profit-loss').getContext('2d');
  if (profitLossChart) {
    profitLossChart.destroy();
  }

  // Calculate profit/loss
  const totalIncome = transactions.filter(t => t.type === 'income').reduce((sum, t) => sum + t.amount, 0);
  const totalExpenseTransactions = transactions.filter(t => t.type === 'expense').reduce((sum, t) => sum + t.amount, 0);
  const totalPurchaseExpense = purchaseInvoices.reduce((sum, inv) => sum + inv.total, 0);
  const totalSalesRevenue = salesInvoices.reduce((sum, inv) => sum + inv.total, 0);

  // Simplified Cost of Goods Sold (COGS) - assuming all purchased items are sold.
  // In a real scenario, this would be complex with inventory tracking.
  // For this demo, let's say purchase invoices are part of COGS or direct expenses.
  const totalExpenses = totalExpenseTransactions + totalPurchaseExpense;

  const profit = totalSalesRevenue - totalExpenses; // A very simplified profit calculation

  profitLossChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: ['درآمد کل (فروش)', 'هزینه کل (تراکنش + خرید)', 'سود/زیان'],
      datasets: [{
        label: 'مبالغ مالی',
        data: [totalSalesRevenue, totalExpenses, profit],
        backgroundColor: [
          'rgba(75, 192, 192, 0.6)', // Income
          'rgba(255, 99, 132, 0.6)', // Expense
          profit >= 0 ? 'rgba(46, 125, 50, 0.6)' : 'rgba(211, 47, 47, 0.6)' // Profit/Loss
        ],
        borderColor: [
          'rgba(75, 192, 192, 1)',
          'rgba(255, 99, 132, 1)',
          profit >= 0 ? 'rgba(46, 125, 50, 1)' : 'rgba(211, 47, 47, 1)'
        ],
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatCurrency(value);
            },
            font: { family: 'Vazirmatn' }
          }
        },
        x: {
          ticks: {
            font: { family: 'Vazirmatn' }
          }
        }
      },
      plugins: {
        title: {
          display: true,
          text: 'گزارش سود و زیان (ساده شده)',
          font: { family: 'Vazirmatn', size: 16 }
        },
        tooltip: {
          rtl: true,
          titleFont: { family: 'Vazirmatn' },
          bodyFont: { family: 'Vazirmatn' },
          callbacks: {
            label: function(context) {
              let label = context.label || '';
              if (label) {
                label += ': ';
              }
              if (context.parsed.y !== null) {
                label += formatCurrency(context.parsed.y) + ' تومان';
              }
              return label;
            }
          }
        },
        legend: {
          rtl: true,
          labels: {
            font: { family: 'Vazirmatn' }
          }
        }
      }
    }
  });
}

function renderCashFlowChart() {
  const ctx = document.getElementById('report-cash-flow').getContext('2d');
  if (cashFlowChart) {
    cashFlowChart.destroy();
  }

  // Monthly cash flow (actual money in/out based on dates)
  const cashFlowData = {}; // {YYYY-MM: { cashIn: 0, cashOut: 0, net: 0 } }

  transactions.forEach(t => {
    const month = t.date.substring(0, 7);
    if (!cashFlowData[month]) {
      cashFlowData[month] = { cashIn: 0, cashOut: 0 };
    }
    if (t.type === 'income') {
      cashFlowData[month].cashIn += t.amount;
    } else {
      cashFlowData[month].cashOut += t.amount;
    }
  });

  // For sales invoices, consider 'paid' ones as cash in
  salesInvoices.filter(inv => inv.status === 'paid').forEach(inv => {
    const month = inv.date.substring(0, 7);
    if (!cashFlowData[month]) {
      cashFlowData[month] = { cashIn: 0, cashOut: 0 };
    }
    cashFlowData[month].cashIn += inv.total;
  });

  // For purchase invoices, consider all as cash out (simplification for this demo)
  // In a real app, you'd track payment status for purchase invoices too
  purchaseInvoices.forEach(inv => {
    const month = inv.date.substring(0, 7);
    if (!cashFlowData[month]) {
      cashFlowData[month] = { cashIn: 0, cashOut: 0 };
    }
    cashFlowData[month].cashOut += inv.total;
  });

  const sortedMonths = Object.keys(cashFlowData).sort();
  const monthlyCashIn = sortedMonths.map(month => cashFlowData[month].cashIn);
  const monthlyCashOut = sortedMonths.map(month => cashFlowData[month].cashOut);
  const monthlyNetCashFlow = sortedMonths.map(month => cashFlowData[month].cashIn - cashFlowData[month].cashOut);

  cashFlowChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: sortedMonths.map(m => {
          const [year, monthNum] = m.split('-');
          const monthName = new Date(year, monthNum - 1, 1).toLocaleString('fa-IR', { month: 'long' });
          return `${monthName} ${year}`;
      }),
      datasets: [
        {
          label: 'ورودی نقدینگی',
          data: monthlyCashIn,
          borderColor: 'rgba(46, 125, 50, 1)', // success color
          backgroundColor: 'rgba(46, 125, 50, 0.2)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'خروجی نقدینگی',
          data: monthlyCashOut,
          borderColor: 'rgba(211, 47, 47, 1)', // danger color
          backgroundColor: 'rgba(211, 47, 47, 0.2)',
          fill: true,
          tension: 0.3
        },
        {
          label: 'خالص جریان نقدینگی',
          data: monthlyNetCashFlow,
          borderColor: 'rgba(75, 192, 192, 1)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          fill: false,
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatCurrency(value);
            },
            font: { family: 'Vazirmatn' }
          }
        },
        x: {
          ticks: {
            font: { family: 'Vazirmatn' }
          }
        }
      },
      plugins: {
        title: {
          display: true,
          text: 'نمودار جریان نقدینگی',
          font: { family: 'Vazirmatn', size: 16 }
        },
        tooltip: {
          rtl: true,
          titleFont: { family: 'Vazirmatn' },
          bodyFont: { family: 'Vazirmatn' },
          callbacks: {
            label: function(context) {
              let label = context.dataset.label || '';
              if (label) {
                label += ': ';
              }
              if (context.parsed.y !== null) {
                label += formatCurrency(context.parsed.y) + ' تومان';
              }
              return label;
            }
          }
        },
        legend: {
          rtl: true,
          labels: {
            font: { family: 'Vazirmatn' }
          }
        }
      }
    }
  });
}

// --- PDF Generation (Enhanced for RTL/Persian) ---
document.getElementById('btn-save-pdf').addEventListener('click', () => {
  const doc = new jspdf.jsPDF(); // Create a new jsPDF instance for each export

  // Set the font and RTL properties for the new document
  doc.addFileToVFS('Vazirmatn-Regular.ttf', VAZIRMATN_NORMAL_BASE64);
  doc.addFont('Vazirmatn-Regular.ttf', 'Vazirmatn', 'normal');
  doc.setFont('Vazirmatn');
  doc.setRTL(true); // Enable Right-to-Left writing

  doc.setFontSize(20);
  doc.text('گزارش تراکنش‌های مالی', doc.internal.pageSize.getWidth() / 2, 20, { align: 'center' }); // Centered title

  doc.setFontSize(10); // Smaller font for table content

  const headers = [['#', 'نوع', 'عنوان', 'مبلغ (تومان)', 'تاریخ']];
  const data = transactions.map((t, index) => [
    (index + 1).toString(),
    t.type === 'income' ? 'درآمد' : 'هزینه',
    t.title,
    formatCurrency(t.amount),
    t.date
  ]);

  // Use jspdf-autotable for table generation
  doc.autoTable({
    head: headers,
    body: data,
    startY: 30,
    theme: 'grid',
    styles: {
      font: 'Vazirmatn', // Use the custom font
      fontStyle: 'normal',
      halign: 'center', // Center align text in cells
      fontSize: 8, // Adjust font size for table
      cellPadding: 2 // Added cell padding for better spacing
    },
    headStyles: {
      fillColor: [75, 108, 183], // Primary color
      textColor: [255, 255, 255]
    },
    alternateRowStyles: {
      fillColor: [243, 246, 255] // Light background
    },
    // This is crucial for RTL text in autoTable and conditional coloring
    didDrawCell: function(data) {
      if (data.section === 'body' && data.column.index === 1) { // Apply color to the "نوع" column
        const text = data.cell.text[0];
        if (text === 'درآمد') {
            doc.setTextColor(46, 125, 50); // Green for income
        } else if (text === 'هزینه') {
            doc.setTextColor(211, 47, 47); // Red for expense
        }
      } else {
        doc.setTextColor(0, 0, 0); // Black for other text
      }
    },
    margin: { right: 10, left: 10 }, // Adjust margins for RTL
    columnStyles: {
        0: { cellWidth: 15 },
        1: { cellWidth: 25 },
        2: { cellWidth: 60 },
        3: { cellWidth: 35 },
        4: { cellWidth: 30 }
    }
  });

  doc.save('گزارش-تراکنش‌ها.pdf');
  showMessage('گزارش PDF با موفقیت ذخیره شد.');
});


// --- Initial Render on Load ---
document.addEventListener('DOMContentLoaded', () => {
  renderTransactions();
  renderSalesInvoices();
  renderPurchaseInvoices();
  renderChecks();
  renderCustomersSuppliers();
  populateCustomerSupplierDatalists(); // Populate datalists on load
  renderInventory();
  renderReturns();
  updateDashboard(); // Initial dashboard load
});

</script>
</body>
</html>  
